<%- include("headerUser") %> <%- include("navbarProfile") %>

<!-- css for justified Gallery -->
<link
   rel="stylesheet"
   href="../../JustifiedGalleryFiles/justifiedGallery.min.css"
/>

<!-- adding leaflet map links -->
<link
   rel="stylesheet"
   href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"
/>

<!-- carousel  at top of page-->
<div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
   <ol class="carousel-indicators">
      <li
         data-target="#carouselExampleIndicators"
         data-slide-to="0"
         class="active"
      ></li>
      <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
      <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
   </ol>
   <div class="carousel-inner">
      <div class="carousel-item active">
         <img class="caroImg" src="/images/_DSC0074-3.jpg" alt="First slide" />
      </div>
      <div class="carousel-item">
         <img class="caroImg" src="/images/_DSC0060.jpg" alt="Second slide" />
      </div>
      <div class="carousel-item">
         <img class="caroImg" src="/images/_DSC0058.jpg" alt="Third slide" />
      </div>
   </div>
   <a
      class="carousel-control-prev"
      href="#carouselExampleIndicators"
      role="button"
      data-slide="prev"
   >
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
   </a>
   <a
      class="carousel-control-next"
      href="#carouselExampleIndicators"
      role="button"
      data-slide="next"
   >
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
   </a>
   <a href="#" class="btn btn-primary">Contact</a>
</div>

<!-- container for top user galleries -->
<!-- TODO -- have carousel for mobile size -->
<div class="container galleryContainer">
   <h1 class="sectionTitle">Galleries</h1>

   <div class="row">
      <figure class="col-lg-4 col-sm-12 img-fluid galleryfig">
         <a
            href="https://mdbootstrap.com/img/Photos/Horizontal/Nature/12-col/img%20(117).jpg"
         >
            <img alt="picture" src="/images/_DSC0074-3.jpg" class="img-fluid" />
         </a>

         <h4>Nature</h4>
         <p>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
            eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim
            ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
            aliquip ex ea commodo consequat. Duis aute irure dolor in
            reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
            pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
            culpa qui officia deserunt mollit anim id est laborum.
         </p>

         <button
            type="button"
            class="btn btn-primary btn-sm"
            href="#"
            name="button"
         >
            View Gallery
         </button>
      </figure>

      <figure class="col-lg-4 col-sm-12 img-fluid galleryfig">
         <a
            href="https://mdbootstrap.com/img/Photos/Horizontal/Nature/12-col/img%20(117).jpg"
         >
            <img alt="picture" src="/images/_DSC0074-3.jpg" class="img-fluid" />
         </a>

         <h4>Nature</h4>
         <p>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
            eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim
            ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
            aliquip ex ea commodo consequat. Duis aute irure dolor in
            reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
            pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
            culpa qui officia deserunt mollit anim id est laborum.
         </p>
      </figure>
      <figure class="col-lg-4 col-sm-12 img-fluid galleryfig">
         <a
            href="https://mdbootstrap.com/img/Photos/Horizontal/Nature/12-col/img%20(117).jpg"
         >
            <img alt="picture" src="/images/_DSC0074-3.jpg" class="img-fluid" />
         </a>

         <h4>Nature</h4>
         <p>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
            eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim
            ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
            aliquip ex ea commodo consequat. Duis aute irure dolor in
            reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
            pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
            culpa qui officia deserunt mollit anim id est laborum.
         </p>
      </figure>
   </div>
</div>

<!-- map  --><!-- TODO -- hide map if no images with GPS tags or have it show home location -->
<h1 class="sectionTitle">Places where <%= contentOwner.name%> has vistited</h1>

<div id="mapid"></div>

<!-- iamge gallery -->

<div id="photoGallery">
   <% photoList.forEach((photo, ndx) =>{%>

   <a href="/photos/<%= photo._id %>/photo">
      <img
         class="justifiedGalImg"
         alt="<%= photo.caption %>"
         src="/uploads/<%= photo.fileName %>"
      />
   </a>

   <% })%>
</div>

<!--gettting data to use in script --- might need to find better way to do this-- data esposed ad looks ugly-->
<p id="photoData" data-photos="<%= JSON.stringify(photoList)%>" hidden></p>

<div id="mapid"></div>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

<p><%= %></p>

<!-- TODO make sure images are loading with low bandwidth and not using too much resources -->
<!-- TODO-- exctract script file -->
<!-- TODO --  only run script if atleast one photo -->
<script>
   //code adapted from here
   //https://stackoverflow.com/questions/38170366/leaflet-adjust-popup-to-picture-size/38172374#38172374
   ////////////////////////
   // document.querySelector(".leaflet-popup-pane").addEventListener("load", function (event) {
   // 	var target = event.target,
   //   		tagName = target.tagName,
   //       popup = map._popup;

   //   console.log("got load event from " + tagName);

   //   if (tagName === "IMG" && popup) {
   //   	popup.update();
   //   }
   // }, true);
   ///////////////////

   const photos = document.getElementById('photoData'); //.photos;
   photosJSON = JSON.parse(photos.dataset.photos);

   //TODO -- viewpost variables do not seem to be working as intended

   // TODO--do better job at handling empty list--right now only running script if a first element
   if (photosJSON[0]) {
      //setting viewport variables (https://stackoverflow.com/questions/1248081/how-to-get-the-browser-viewport-dimensions)
      const vw = Math.max(
         document.documentElement.clientWidth || 0,
         window.innerWidth || 0,
      );
      const vh = Math.max(
         document.documentElement.clientHeight || 0,
         window.innerHeight || 0,
      );

      console.log('DEBUG: vh is ' + vh);

      var mymap = L.map('mapid').setView([20, 0], 2, {
         //the last num is the zoom, the two in brackets are the coords
         zoomControl: false,
      });
      mymap.scrollWheelZoom.disable();

      //console.log(photosJSON[0]._id);
      photosJSON.forEach((photo) => {
         if (
            photo.latitude &&
            photo.latitude.length > 0 &&
            photo.longitude &&
            photo.longitude.length > 0
         ) {
            // TODO--currently no safeguards against improper GPS coords
            //TODO -- seperate styles

            function generatePopupString(photo, viewPortH, viewPortW) {
               const vw = Math.max(
                  document.documentElement.clientWidth || 0,
                  window.innerWidth || 0,
               );
               const vh = Math.max(
                  document.documentElement.clientHeight || 0,
                  window.innerHeight || 0,
               );

               let maxWidth = Math.floor(vw * 0.5);
               let maxHeight = Math.floor(vh * 0.4);

               console.log('max width:' + maxWidth);
               returnString =
                  '<img style="max-width:' +
                  maxWidth +
                  'px;max-height:' +
                  maxHeight +
                  'px" src="/uploads/' + //TODO would want to change to a thumbnail
                  photo.fileName +
                  '"/>' +
                  '<h3>' +
                  photo.caption +
                  '</h3> <h4>submitted by ' +
                  photo.author +
                  '</h4> <p>' +
                  photo.latitude +
                  ' -- ' +
                  photo.longitude;
               console.log(returnString);
               return returnString;
            }

            //TODO -- could extract this as a partial or make int a function// TODO could include city location in future
            let photoPin = L.marker([photo.latitude, photo.longitude])
               .bindPopup(generatePopupString(photo, vh, vw), {
                  maxWidth: 'auto',
               })

               .addTo(mymap);
            // .on('click'); //displayImage function can be added here

            // photoPin.photoID = photo._id;
         } else {
            console.log('cannot get lon/lat');
         }

         //console.log(photo);
      });

      // function displayImage(e) {
      //    alert('click' + this.photoID);
      // }

      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
         attribution:
            '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(mymap);
   }
</script>

<!-- jquerry -- needed for justified gallery -->
<script
   src="https://code.jquery.com/jquery-3.5.1.min.js"
   integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
   crossorigin="anonymous"
></script>

<!-- script for including justified gallery -->
<script src="../../JustifiedGalleryFiles/jquery.justifiedGallery.min.js"></script>

<!-- justified gallery script for page -->
<script>
   //setting viewport variables (https://stackoverflow.com/questions/1248081/how-to-get-the-browser-viewport-dimensions)
   const vw = Math.max(
      document.documentElement.clientWidth || 0,
      window.innerWidth || 0,
   );
   const vh = Math.max(
      document.documentElement.clientHeight || 0,
      window.innerHeight || 0,
   );

   $('#photoGallery').justifiedGallery({
      rowHeight: Math.floor(vh / 3.3),
      lastRow: 'nojustify',
      margins: 20,
      lastRow: 'center',
   });
   // .on('jg.complete', function () {
   //    var justifiedGalImgs = document.getElementsByClassName(
   //       'justifiedGalImg',
   //    );

   //    var addClickListenerToImgPage = function () {
   //       alert('click');
   //    };

   //    for (var i = 0; i < justifiedGalImgs.length; i++) {
   //       justifiedGalImgs[i].addEventListener(
   //          'click',
   //          addClickListenerToImgPage,
   //          false,
   //       );
   //    }
   // });
</script>

<%- include("footerUser") %>
